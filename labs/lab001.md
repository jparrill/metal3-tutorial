# Lab 1: Introduction / Deployment 

At this point we will try to deploy a Kubernetes cluster on our lab/laptop/server using this [repository](https://github.com/metal3-io/metal3-dev-env).

**DISCLAIMER:** This header is just for our own purpose. If you find it during the laboratory, don't worry about, **you don't need execute it!**:

```bash @mdsh
mdsh-lang-bash() { shell; }
```

## Requirements

- Bare metal preferred, as we will be creating VMs to emulate bare metal hosts.
- CentOS 7 or Ubuntu 18.04 OS based
- Run as a user with passwordless sudo access
- `make` app

## Hands on lab

Let's get started going to a temporary folder and then clone the metal3-dev-env repository in order to spin up a k8s cluster

```shell
mkdir -p /tmp/metal3
git clone https://github.com/metal3-io/metal3-dev-env.git /tmp/metal3-dev-env
cd /tmp/metal3-dev-env
make
```

This will take some minutes to finish, and at the end of the execution you will see a some tests passing to validate that the deployment was right:

```
Logging to ./logs/04_verify-2019-09-02-150259.log
OK - Network provisioning exists
OK - Network baremetal exists
OK - Kubernetes cluster reachable

OK - Fetch CRDs
OK - CRD baremetalhosts.metal3.io created
OK - CRD clusters.cluster.k8s.io created
OK - CRD machineclasses.cluster.k8s.io created
OK - CRD machinedeployments.cluster.k8s.io created
OK - CRD machines.cluster.k8s.io created
OK - CRD machinesets.cluster.k8s.io created

   - Waiting for task completion (up to 1200 seconds)
OK - statefulsets cluster-api-controller-manager created
OK - cluster-api-controller-manager statefulsets replicas correct
   - Waiting for task completion (up to 1200 seconds)
OK - deployments metal3-baremetal-operator created
OK - metal3-baremetal-operator deployments replicas correct
OK - Replica set metal3-baremetal-operator created
OK - metal3-baremetal-operator replicas correct
OK - Fetch Baremetalhosts
OK - Fetch Baremetalhosts VMs

   - Waiting for task completion (up to 1200 seconds)
OK - master-0 Baremetalhost exist
OK - master-0 Baremetalhost address correct
OK - master-0 Baremetalhost mac address correct
OK - master-0 Baremetalhost status OK
OK - master-0 Baremetalhost credentials secret exist
OK - master-0 Baremetalhost password correct
OK - master-0 Baremetalhost user correct
OK - master-0 Baremetalhost VM exist
OK - master-0 Baremetalhost VM interface provisioning exist
OK - master-0 Baremetalhost VM interface baremetal exist
OK - master-0 Baremetalhost introspecting completed

OK - worker-0 Baremetalhost exist
OK - worker-0 Baremetalhost address correct
OK - worker-0 Baremetalhost mac address correct
OK - worker-0 Baremetalhost status OK
OK - worker-0 Baremetalhost credentials secret exist
OK - worker-0 Baremetalhost password correct
OK - worker-0 Baremetalhost user correct
OK - worker-0 Baremetalhost VM exist
OK - worker-0 Baremetalhost VM interface provisioning exist
OK - worker-0 Baremetalhost VM interface baremetal exist
OK - worker-0 Baremetalhost introspecting completed

OK - Container ironic running
OK - Container ironic-inspector running
OK - Container dnsmasq running
OK - Container httpd running
OK - Container mariadb running


Number of failures : 0
```

If you see this prompt, it's done but we will see what happened more in detail and those commands will help you:

- `sudo virsh list` - List created VMs
- `sudo virsh net-dhcp-leases baremetal` - List VM networking details 
- `kubectl get baremetalhost -n metal3` - List BareMetalNodes created and defined in the API 
- List and show Nodes from Ironic view
```
export OS_TOKEN=fake-token
export OS_URL=http://localhost:6385/
openstack baremetal node list
```
- `kubectl get machines -n metal3` - List Machines created 
- `vbmc list` - (Virtual Baseboard Management Controller (BMC) backed by virtual machines) List of VMs from BMC point of view.

Then we have 3 nodes here

- Minikube, that will act as a cluster manager
- Master_0 and Worker_0 which will be the Baremetal Hosts.

Let's see what's the difference between some objects that could confuse you.

### BareMetalHost vs Machine vs Node

Here we have 3 separated objects:

- **Node** objects represent a running instance of kubelet. Their status fields include basic information about the health of the environment in which kubelet is running.
- **Machine** objects represent a request for an instance of kubelet. Machine objects include a "provider spec" field to allow the actuator to store custom data. The lifecycle of a Machine is based on the desired size of the cluster
- The **BareMetalHost** resource defines the properties of a physical host necessary to manage and provision it.

#### Reference: [Nodes, Machines and Hosts](https://github.com/metal3-io/metal3-docs/blob/master/design/nodes-machines-and-hosts.md#data-model)


### Scripts & Utilities

Now we have some script that could be very useful to work with our VMs

- `create_machine.sh` - Creates a new **Machine** definition on K8s API, then BMO check that a new object exists and needs to make it real. It uses ironic to provision the machine.
- `provision_host.sh` - Creates a new **BareMetalHost**, depending on the manifest the BMH will be also provisioned with a concrete user-data. In this case the BMH created is just a CentOS7 basic node.


### Other tools

- `make-bm-worker` - This is not a script that exists on the repo, it's just a dependency downloaded during the k8s deployment, to execute it do this:
```
go run $GOPATH/src/github.com/metal3-io/baremetal-operator/cmd/make-bm-worker/main.go -address ipmi://192.168.111.1:6232 -password password -user admin -boot-mac 00:6c:f2:66:00:fc worker-1 | kubectl create -n metal3 -f -
```
  This script will create a new BareMetalHost on Ironic, and also on K8s API in order to let BMO connect to the ipmi address and then boot it up, provision it and so on, but it needs to exists previously on the destination provider, Libvirt in this case. If the VM does not exists you will get this error:
  ```
  Failed to get power state for node "NODE ID". Error: IPMI call failed: power status
  ```
  Other thing that you need to have in mind is the user-data, here we are not injecting any useful data. check the `user_data.sh` script to know how MetalÂ³ folks inject the data. 

